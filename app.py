# -*- coding: utf-8 -*-
import streamlit as st
from google import genai
import os
import datetime # â˜… datetimeãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’importã—ã¦ãã ã•ã„

# ----------------------------------------------------
# ç”»é¢ãƒ‡ã‚¶ã‚¤ãƒ³ã¨ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
# ----------------------------------------------------
st.set_page_config(page_title="Reframe: å®‰å¿ƒã®ä¸€æ­©", layout="centered")
st.title("ğŸ’¡ Reframe: ãƒã‚¸ãƒ†ã‚£ãƒ–å¤‰æ›æ—¥è¨˜")
st.markdown("---")
st.markdown("**ãƒã‚¬ãƒ†ã‚£ãƒ–ãªå‡ºæ¥äº‹ã‚’æ›¸ãè¾¼ã¿ã€AIã®åŠ›ã§å­¦ã³ã¨è¡Œå‹•æ¡ˆã«å¤‰æ›ã—ã¾ã™ã€‚**")

# ----------------------------------------------------
# Gemini APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
# ----------------------------------------------------
# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã‚€è¨­å®šã€‚ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å¿…è¦ã€‚
# Colabã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã¯ã€ã“ã“ã§ã‚­ãƒ¼ã‚’ç›´æ¥è¨­å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€ç’°å¢ƒå¤‰æ•°(st.secrets)ã‚’ä½¿ã†ã®ãŒãƒ™ã‚¹ãƒˆã§ã™ã€‚
try:
    # st.secrets['tool']['GEMINI_API_KEY'] ã‹ã‚‰ã‚­ãƒ¼ã‚’ç›´æ¥å–å¾—ã™ã‚‹
    API_KEY = st.secrets["tool"]["GEMINI_API_KEY"]
    client = genai.Client(api_key=API_KEY)
except KeyError:
    st.error("APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Streamlit Cloudã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®šï¼ˆ[tool]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    st.stop()
except Exception as e:
    st.error(f"APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼: {e}")
    st.stop()    
# ----------------------------------------------------
# æ„Ÿæƒ…ã‚’ãƒã‚¸ãƒ†ã‚£ãƒ–ã«å¤‰æ›ã™ã‚‹é–¢æ•° (ã‚³ã‚¢æ©Ÿèƒ½)
# ----------------------------------------------------
def reframe_negative_emotion(negative_text):
    system_prompt = """
    ã‚ãªãŸã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç²¾ç¥çš„å®‰å…¨æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã®å„ªç§€ãªAIãƒ¡ãƒ³ã‚¿ãƒ¼ã§ã™ã€‚
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒã‚¬ãƒ†ã‚£ãƒ–ãªæ„Ÿæƒ…ã‚„å‡ºæ¥äº‹ã«å¯¾ã—ã€ä»¥ä¸‹ã®å³æ ¼ãª3ã¤ã®å½¢å¼ã§åˆ†æã—ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå†æ§‹ç¯‰ã‚’ã—ã¦ãã ã•ã„ã€‚
    
    ã€å‡ºåŠ›å½¢å¼ã€‘
    ### 1. äº‹å®Ÿã®å®¢è¦³è¦–
    (äº‹å®Ÿã®ã¿ã‚’ç°¡æ½”ã«è¦ç´„)
    
    ### 2. ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå´é¢æŠ½å‡º
    (ã“ã®å‡ºæ¥äº‹ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸæˆé•·ã€å­¦ã³ã€æ”¹å–„ç‚¹ã‚’æŠ½å‡º)
    
    ### 3. ä»Šå¾Œã®å…·ä½“çš„ãªè¡Œå‹•æ¡ˆï¼ˆNext Stepï¼‰
    (å°ã•ãã€ã™ãå®Ÿè¡Œã§ãã‚‹æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸€ã¤ææ¡ˆ)
    
    å¿…ãšã“ã®3ã¤ã®Markdownå½¢å¼ã®è¦ç´ ã‚’å‡ºåŠ›ã—ã€ãã‚Œä»¥å¤–ã®èª¬æ˜ã‚„æŒ¨æ‹¶ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚
    """
    
    try:
        response = client.models.generate_content(
            model="gemini-2.5-flash",
            contents=[
                {"role": "user", "parts": [{"text": system_prompt + "\n\nåˆ†æå¯¾è±¡ã®å‡ºæ¥äº‹:\n" + negative_text}]}
            ]
        )
        return response.text
        
    except Exception as e:
        return f"Gemini APIå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"

# ----------------------------------------------------
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ (UI)
# ----------------------------------------------------

# ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢
negative_input = st.text_area(
    "ä»Šæ—¥ã®ãƒã‚¬ãƒ†ã‚£ãƒ–ãªå‡ºæ¥äº‹ã‚’ã€ãã®ã¾ã¾ã®æ°—æŒã¡ã§æ›¸ãå‡ºã—ã¦ãã ã•ã„ã€‚", 
    height=200,
    placeholder="ä¾‹ï¼šé¢æ¥ã§å¹´é½¢ã®æ‡¸å¿µã‚’çªã£è¾¼ã¾ã‚Œã¦ã€è‡ªä¿¡ã‚’å¤±ã„ãã†ã«ãªã£ãŸã€‚ä»Šæ—¥ã®CWã®ãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã¯ä¸æ¡ç”¨ã ã£ãŸã€‚"
)

# å¤‰æ›ãƒœã‚¿ãƒ³
if st.button("ãƒã‚¸ãƒ†ã‚£ãƒ–ã«å¤‰æ›ã™ã‚‹ï¼", type="primary"):
    if negative_input:
        with st.spinner("æ€è€ƒã‚’æ•´ç†ã—ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå´é¢ã‚’æŠ½å‡ºä¸­..."):
            # 1.ã‚³ã‚¢é–¢æ•°ã‚’å‘¼ã³å‡ºã—
            converted_result = reframe_negative_emotion(negative_input)

            # 2. å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆãƒ»ä¿å­˜ ã€â˜…ã“ã“ã‚’è¿½è¨˜/ä¿®æ­£â˜…ã€‘
            new_entry = {
                "timestamp": datetime.datetime.now().strftime("%Y/%m/%d %H:%M"),
                "negative": negative_input,
                "positive_reframe": converted_result
            }
            st.session_state.history.insert(0, new_entry)
            
            # 3.çµæœè¡¨ç¤º
            st.markdown("---")
            st.subheader("ğŸ‰ Reframe å®Œäº†ï¼å®‰å¿ƒã®ä¸€æ­©")
            st.markdown(converted_result)
    else:
        st.warning("ä½•ã‹å‡ºæ¥äº‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# ----------------------------------------------------
# å±¥æ­´ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ (UIã®æœ€å¾Œã®æ–¹ã«è¿½è¨˜)
# ----------------------------------------------------
st.markdown("---")
st.subheader("ğŸ“š éå»ã®ãƒã‚¸ãƒ†ã‚£ãƒ–å¤‰æ›æ—¥è¨˜")

if st.session_state.history:
    for entry in st.session_state.history:
        st.caption(f"ğŸ—“ï¸ å¤‰æ›æ—¥æ™‚: {entry['timestamp']}")
        st.code(f"ãƒã‚¬ãƒ†ã‚£ãƒ–: {entry['negative']}", language='text')
        st.markdown("**å¤‰æ›çµæœ:**")
        st.markdown(entry['positive_reframe']) 
        st.markdown("---")
else:
    st.write("ã¾ã å¤‰æ›è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®å‡ºæ¥äº‹ã‚’æ›¸ãè¾¼ã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼")

# (æ³¨: Colabã§ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã§Streamlitã‚’ç«‹ã¡ä¸Šã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚)
